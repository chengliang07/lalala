<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯†å­—æµ‹è¯•ç³»ç»Ÿ (V19.1 - ç¨³å®šç½‘ç»œç‰ˆ)</title>
    <!-- [ä¿®æ”¹] æ›´æ¢ä¸ºæ›´ç¨³å®šçš„ jsDelivr CDN æº -->
    <script src="https://unpkg.com/pinyin-pro@3.26.0/dist/index.js"></script>
    <!-- å¼•å…¥ SheetJS åº“ï¼Œç”¨äºç”Ÿæˆ Excel æ–‡ä»¶ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* å…¨å±€å˜é‡ */
        :root {
            --primary-color: #007bff;
            --primary-hover: #0056b3;
            --success-color: #28a745;
            --success-hover: #218838;
            --warning-color: #ffc107;
            --danger-color: #dc3545;
            --light-bg: #f0f8ff;
            --text-color: #333;
            --text-secondary: #6c757d;
            --border-radius: 8px;
            --box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            margin: 0; 
            background-color: var(--light-bg);
            color: var(--text-color);
        }
        
        .container { 
            width: 90%; 
            max-width: 600px; 
            background: white; 
            padding: 2rem; 
            border-radius: var(--border-radius); 
            box-shadow: var(--box-shadow); 
            text-align: center; 
            transition: var(--transition);
        }
        
        .hidden { display: none; }
        
        h1, h2, h3 { 
            color: var(--primary-color); 
            margin-bottom: 1.5rem; 
        }

        h3 {
             margin-top: 1.5rem;
        }
        
        button { 
            padding: 12px 25px; 
            font-size: 1.2rem; 
            border: none; 
            border-radius: var(--border-radius); 
            background-color: var(--primary-color); 
            color: white; 
            cursor: pointer; 
            transition: var(--transition);
            margin: 0.25rem;
        }
        
        button:hover { 
            background-color: var(--primary-hover); 
            transform: translateY(-2px);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        button:disabled { 
            background-color: #cccccc; 
            cursor: not-allowed; 
            transform: none;
        }
        
        .form-group { 
            margin-bottom: 1.5rem; 
        }
        
        input[type="text"], input[type="password"] { 
            width: 80%; 
            padding: 12px; 
            font-size: 1.1rem; 
            border: 1px solid #ccc; 
            border-radius: var(--border-radius); 
            transition: var(--transition);
        }
        
        input[type="text"]:focus, input[type="password"]:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        
        #login-error, #admin-error { 
            color: var(--danger-color); 
            margin-top: 1rem; 
            min-height: 1.2rem; 
            font-weight: bold; 
        }
        
        #test-screen #char-display { 
            font-size: 15rem; 
            font-weight: bold; 
            color: var(--text-color); 
            margin: 2rem 0; 
            line-height: 1; 
            font-family: 'KaiTi', 'æ¥·ä½“', serif; 
            transition: var(--transition);
        }
        
        #test-screen #mic-btn { 
            font-size: 3rem; 
            width: 100px; 
            height: 100px; 
            border-radius: 50%; 
            background-color: var(--success-color); 
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        
        #test-screen #mic-btn:hover { 
            background-color: var(--success-hover); 
        }
        
        #test-screen #status-text { 
            margin-top: 1.5rem; 
            font-size: 1.2rem; 
            color: var(--text-secondary); 
            min-height: 3.5rem; 
            line-height: 1.5; 
        }
        
        #test-screen #progress-text { 
            font-size: 1rem; 
            color: var(--text-secondary); 
            margin-top: 1rem;
        }
        
        #report-screen h2 { 
            color: var(--success-color); 
        }
        
        #report-screen #summary { 
            font-size: 1.2rem; 
            margin-bottom: 2rem; 
            line-height: 1.8; 
        }
        
        #report-screen #error-table { 
            width: 100%; 
            margin-top: 1rem; 
            border-collapse: collapse; 
        }
        
        #report-screen #error-table th, 
        #report-screen #error-table td { 
            border: 1px solid #ddd; 
            padding: 12px; 
            font-size: 1.1rem; 
        }
        
        #report-screen #error-table th { 
            background-color: #f2f2f2; 
            color: var(--text-color); 
        }
        
        #report-screen #no-errors { 
            color: var(--success-color); 
            font-size: 1.2rem; 
            font-weight: bold; 
        }
        
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: var(--success-hover); }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c82333; }
        .btn-secondary { background-color: var(--text-secondary); }
        .btn-secondary:hover { background-color: #5a6268; }
        .feedback-correct { color: var(--success-color); font-weight: bold; }
        .feedback-incorrect { color: var(--danger-color); font-weight: bold; }
        .feedback-warning { color: var(--warning-color); font-weight: bold; }
        
        @media (max-width: 768px) {
            .container { width: 95%; padding: 1.5rem; }
            #test-screen #char-display { font-size: 10rem; }
        }
        @media (max-width: 480px) {
            #test-screen #char-display { font-size: 8rem; }
            button { padding: 10px 20px; font-size: 1rem; }
            #test-screen #mic-btn { width: 80px; height: 80px; font-size: 2.5rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å­¦ç”Ÿç™»å½•ç•Œé¢ -->
        <div id="login-screen">
            <h1>ä¸€å¹´çº§è¯†å­—æµ‹è¯•</h1>
            <div class="form-group"><input type="text" id="student-id" placeholder="è¯·è¾“å…¥å­¦å·"></div>
            <div class="form-group"><input type="text" id="student-name" placeholder="è¯·è¾“å…¥å§“å"></div>
            <button id="login-btn">å¼€å§‹æµ‹è¯•</button>
            <p id="login-error"></p>
            <a href="#" id="admin-login-link" style="display: block; margin-top: 1rem;">ç®¡ç†å‘˜å…¥å£</a>
        </div>

        <!-- æµ‹è¯•ç•Œé¢ -->
        <div id="test-screen" class="hidden">
            <p id="student-info"></p><div id="char-display">å­—</div><p id="status-text">ç‚¹å‡»ä¸‹é¢çš„éº¦å…‹é£ï¼Œå¤§å£°è¯»å‡ºè¿™ä¸ªå­—</p><button id="mic-btn">ğŸ¤</button><p id="progress-text"></p>
        </div>

        <!-- æŠ¥å‘Šç•Œé¢ -->
        <div id="report-screen" class="hidden">
            <h2>æµ‹è¯•æŠ¥å‘Š</h2>
            <div id="summary"></div>
            <h3>é”™è¯¯åˆ—è¡¨</h3>
            <div id="error-list">
                <p id="no-errors" class="hidden">å¤ªæ£’äº†ï¼Œå…¨éƒ¨æ­£ç¡®ï¼</p>
                <table id="error-table" class="hidden">
                    <thead>
                        <tr>
                            <th>æ±‰å­—</th>
                            <th>æ­£ç¡®å‘éŸ³</th>
                            <th>ä½ çš„å‘éŸ³(è¯†åˆ«ç»“æœ)</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            <br>
            <button id="restart-btn">é‡æ–°æµ‹è¯•</button>
            <button id="download-btn" class="btn-success">ä¸‹è½½ExcelæŠ¥å‘Š</button>
        </div>

        <!-- ç®¡ç†å‘˜åå°ç•Œé¢ -->
        <div id="admin-screen" class="hidden">
            <h1>ç®¡ç†å‘˜åå°</h1>
            <div class="form-group" id="admin-login-form">
                <label for="admin-password">ç®¡ç†å‘˜å¯†ç :</label>
                <input type="password" id="admin-password" placeholder="è¯·è¾“å…¥å¯†ç ">
                <button id="admin-login-btn">ç™»å½•</button>
                <p id="admin-error"></p>
            </div>
            <div id="admin-panel" class="hidden" style="text-align: left;">
                <h3>å­—åº“ç®¡ç†</h3>
                <p>è¯·ä¸Šä¼  CSV æ ¼å¼çš„å­—åº“æ–‡ä»¶ (æ ¼å¼: character,pinyins)ã€‚</p>
                <input type="file" id="char-file-input" accept=".csv" style="margin: 1rem 0;">
                <p id="upload-status" style="color: var(--success-color);"></p>
                <hr style="margin: 1.5rem 0;">
                <h3>å½“å‰å­—åº“çŠ¶æ€</h3>
                <div id="char-lib-status"></div>
                <hr style="margin: 1.5rem 0;">
                <button id="reset-lib-btn" class="btn-danger">æ¸…ç©ºè‡ªå®šä¹‰å­—åº“ (æ¢å¤é»˜è®¤)</button>
                <button id="admin-logout-btn" class="btn-secondary" style="float: right;">é€€å‡ºç™»å½•</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- æ•°æ®æ¨¡å‹ ---
        const AppData = {
            /* pinyinDict ä¸å†éœ€è¦ï¼Œç”± pinyin-pro åº“æ›¿ä»£ */
            students: [
                { id: "101", name: "å¼ å°æ˜" },
                { id: "102", name: "æå°çº¢" },
                { id: "1", name: "æµ‹è¯•" }
            ],
            characters: [ // è¿™æ˜¯é»˜è®¤å­—åº“
                { character: "å¥½", pinyins: ["hao3"] },
                { character: "è¡Œ", pinyins: ["xing2", "hang2"] },
                { character: "ä¹", pinyins: ["le4", "yue4"] },
                { character: "ä¸º", pinyins: ["wei2", "wei4"] },
                { character: "ä¸­", pinyins: ["zhong1", "zhong4"] }
            ],
            state: {
                currentUser: null,
                testChars: [],
                currentIndex: 0,
                testResults: [],
                feedbackDelay: 2000,
                passScore: 60
            },
            admin: {
                password: "admin", // ç®¡ç†å‘˜å¯†ç 
                charLibKey: "custom_char_library" // localStorage é”®å
            },
            storage: {
                historyKey: 'literacy_test_history'
            }
        };
        
        // --- å·¥å…·å‡½æ•° ---
        const Utils = {
            getPinyinsFromText(text) {
                if (typeof pinyinPro === 'undefined') {
                    console.error("pinyin-pro åº“æœªåŠ è½½ï¼Œæ— æ³•è·å–æ‹¼éŸ³ã€‚");
                    return [];
                }
                const pinyins = pinyinPro.pinyin(text, { toneType: 'num', type: 'array' });
                return [...new Set(pinyins)];
            },
            cleanRecognizedText(text) {
                const cleanedPunctuation = text.trim().replace(/[ã€‚ï¼Œï¼Ÿï¼.?,!]$/, '');
                return cleanedPunctuation.replace(/[^\u4e00-\u9fa5]/g, '');
            },
            shuffleArray(array) {
                return [...array].sort(() => 0.5 - Math.random());
            },
            formatDateTime(date) {
                const d = date || new Date();
                return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
            },
            saveTestHistory(result) {
                try {
                    const history = JSON.parse(localStorage.getItem(AppData.storage.historyKey) || '[]');
                    history.push({ ...result, timestamp: new Date().toISOString() });
                    localStorage.setItem(AppData.storage.historyKey, JSON.stringify(history));
                    return true;
                } catch (e) {
                    console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
                    return false;
                }
            }
        };
        
        // --- DOMå…ƒç´  ---
        const UI = {
            screens: {
                login: document.getElementById('login-screen'),
                test: document.getElementById('test-screen'),
                report: document.getElementById('report-screen'),
                admin: document.getElementById('admin-screen')
            },
            login: {
                idInput: document.getElementById('student-id'),
                nameInput: document.getElementById('student-name'),
                submitBtn: document.getElementById('login-btn'),
                errorMsg: document.getElementById('login-error'),
                adminLoginLink: document.getElementById('admin-login-link')
            },
            test: {
                studentInfo: document.getElementById('student-info'),
                charDisplay: document.getElementById('char-display'),
                statusText: document.getElementById('status-text'),
                micBtn: document.getElementById('mic-btn'),
                progressText: document.getElementById('progress-text')
            },
            report: {
                summary: document.getElementById('summary'),
                noErrors: document.getElementById('no-errors'),
                errorTable: document.getElementById('error-table'),
                errorTableBody: document.querySelector('#error-table tbody'),
                restartBtn: document.getElementById('restart-btn'),
                downloadBtn: document.getElementById('download-btn')
            },
            admin: {
                loginForm: document.getElementById('admin-login-form'),
                passwordInput: document.getElementById('admin-password'),
                loginBtn: document.getElementById('admin-login-btn'),
                errorMsg: document.getElementById('admin-error'),
                panel: document.getElementById('admin-panel'),
                fileInput: document.getElementById('char-file-input'),
                uploadStatus: document.getElementById('upload-status'),
                libStatus: document.getElementById('char-lib-status'),
                resetBtn: document.getElementById('reset-lib-btn'),
                logoutBtn: document.getElementById('admin-logout-btn')
            },
            showScreen(screenName) {
                Object.keys(this.screens).forEach(key => {
                    this.screens[key].classList.add('hidden');
                });
                this.screens[screenName].classList.remove('hidden');
            },
            updateStatus(message, type = 'normal') {
                const classMap = {
                    normal: '', success: 'feedback-correct',
                    error: 'feedback-incorrect', warning: 'feedback-warning'
                };
                const className = classMap[type] || '';
                this.test.statusText.innerHTML = className ? `<span class="${className}">${message}</span>` : message;
            }
        };
        
        // --- åº”ç”¨é€»è¾‘ ---
        const App = {
            init() {
                if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
                    UI.login.errorMsg.textContent = 'é”™è¯¯ï¼šæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ã€‚';
                    UI.login.submitBtn.disabled = true;
                }
                if (typeof pinyinPro === 'undefined') {
                    console.error("pinyin-pro åº“æœªèƒ½åŠ è½½ï¼Œæ‹¼éŸ³è¯†åˆ«åŠŸèƒ½å°†å—é™ã€‚");
                    alert("é”™è¯¯ï¼šæ‹¼éŸ³æ”¯æŒåº“æœªèƒ½åŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å¹¶åˆ·æ–°é¡µé¢ã€‚");
                }
                if (typeof XLSX === 'undefined') {
                    console.error("SheetJS åº“ (xlsx)æœªèƒ½åŠ è½½ï¼ŒExcelä¸‹è½½åŠŸèƒ½å°†ä¸å¯ç”¨ã€‚");
                }
                this.loadCustomCharLibrary();
                this.bindEvents();
            },
            bindEvents() {
                UI.login.submitBtn.addEventListener('click', () => this.handleLogin());
                UI.login.nameInput.addEventListener('keyup', (e) => { if (e.key === 'Enter') UI.login.submitBtn.click(); });
                UI.test.micBtn.addEventListener('click', () => this.startSpeechRecognition());
                UI.report.restartBtn.addEventListener('click', () => this.restartApp());
                UI.report.downloadBtn.addEventListener('click', () => this.downloadReport());
                // ç®¡ç†å‘˜äº‹ä»¶
                UI.login.adminLoginLink.addEventListener('click', (e) => { e.preventDefault(); this.showAdminLogin(); });
                UI.admin.loginBtn.addEventListener('click', () => this.handleAdminLogin());
                UI.admin.fileInput.addEventListener('change', (e) => this.handleFileUpload(e));
                UI.admin.resetBtn.addEventListener('click', () => this.resetCharLibrary());
                UI.admin.logoutBtn.addEventListener('click', () => this.restartApp());
            },
            handleLogin() {
                const id = UI.login.idInput.value.trim();
                const name = UI.login.nameInput.value.trim();
                if (!id || !name) {
                    UI.login.errorMsg.textContent = "å­¦å·å’Œå§“åä¸èƒ½ä¸ºç©ºï¼";
                    return;
                }
                const foundUser = AppData.students.find(user => user.id === id && user.name === name);
                if (foundUser) {
                    AppData.state.currentUser = foundUser;
                    UI.login.errorMsg.textContent = '';
                    this.startTest();
                } else {
                    UI.login.errorMsg.textContent = "å­¦å·æˆ–å§“åé”™è¯¯ï¼";
                }
            },
            startTest() {
                AppData.state.currentIndex = 0;
                AppData.state.testResults = [];
                
                const shuffledLibrary = Utils.shuffleArray(AppData.characters);
                const testSize = 5;
                AppData.state.testChars = shuffledLibrary.slice(0, testSize);

                if (AppData.characters.length < testSize) {
                     AppData.state.testChars = shuffledLibrary;
                     console.warn(`å­—åº“æ€»æ•° (${AppData.characters.length}) å°äºè®¾å®šçš„æµ‹è¯•æ•°é‡ (${testSize})ï¼Œå°†æµ‹è¯•æ‰€æœ‰å­—ã€‚`);
                }

                if (AppData.state.testChars.length === 0) {
                    alert("é”™è¯¯ï¼šé¢˜åº“ä¸ºç©ºï¼Œæ— æ³•å¼€å§‹æµ‹è¯•ã€‚è¯·è”ç³»ç®¡ç†å‘˜ä¸Šä¼ å­—åº“ã€‚");
                    this.restartApp();
                    return;
                }
                UI.test.studentInfo.textContent = `å­¦ç”Ÿ: ${AppData.state.currentUser.name} (${AppData.state.currentUser.id})`;
                UI.showScreen('test');
                this.displayNextChar();
            },
            displayNextChar() {
                const { currentIndex, testChars } = AppData.state;
                if (currentIndex >= testChars.length) {
                    this.showReport();
                    return;
                }
                const currentWord = testChars[currentIndex];
                UI.test.charDisplay.textContent = currentWord.character;
                UI.test.progressText.textContent = `è¿›åº¦: ${currentIndex + 1} / ${testChars.length}`;
                UI.updateStatus("å‡†å¤‡å¥½äº†å—ï¼Ÿç‚¹å‡»éº¦å…‹é£å¼€å§‹");
                UI.test.micBtn.disabled = false;
                UI.test.micBtn.textContent = 'ğŸ¤';
                this.warmUpSpeechRecognition();
            },
            startSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'zh-CN';
                recognition.interimResults = false;
                recognition.maxAlternatives = 3;
                
                UI.updateStatus("è¯·ç¨å€™ï¼Œæ­£åœ¨å¯åŠ¨éº¦å…‹é£...", "warning");
                UI.test.micBtn.textContent = '...';
                UI.test.micBtn.disabled = true;

                recognition.onstart = () => {
                    UI.updateStatus("è¯·è¯´è¯ï¼", "success");
                };
                
                recognition.onresult = (e) => {
                    this.checkAnswer(e.results[0][0].transcript);
                };
                
                recognition.onerror = (e) => {
                    let msg = "å‡ºé”™äº†ï¼Œè¯·å†è¯•ä¸€æ¬¡", type = "warning";
                    if (e.error === 'no-speech' || e.error === 'audio-capture') {
                        msg = e.error === 'no-speech' ? "æ²¡æœ‰å¬åˆ°å£°éŸ³ï¼Œè¯·é‡è¯•" : "éº¦å…‹é£æ•è·éŸ³é¢‘å¤±è´¥ï¼Œè¯·é‡è¯•";
                        UI.updateStatus(msg, type);
                        setTimeout(() => {
                            UI.updateStatus("è¯·é‡è¯•ï¼šç‚¹å‡»éº¦å…‹é£ï¼Œå¤§å£°è¯»å‡ºè¿™ä¸ªå­—");
                            UI.test.micBtn.disabled = false;
                            UI.test.micBtn.textContent = 'ğŸ¤';
                        }, AppData.state.feedbackDelay);
                    } else {
                        if (e.error === 'not-allowed') {
                            msg = "æœªå…è®¸ä½¿ç”¨éº¦å…‹é£ï¼Œæµ‹è¯•æ— æ³•ç»§ç»­ã€‚è¯·åˆ·æ–°é¡µé¢å¹¶å…è®¸æƒé™ã€‚";
                        } else if (e.error === 'network') {
                            msg = "ç½‘ç»œè¿æ¥å‡ºé”™ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•";
                        }
                        UI.updateStatus(msg, type);
                        setTimeout(() => {
                            AppData.state.currentIndex++;
                            this.displayNextChar();
                        }, AppData.state.feedbackDelay);
                    }
                };
                
                recognition.start();
            },
            checkAnswer(recognizedText) {
                const originalResult = recognizedText; 
                const cleanedText = Utils.cleanRecognizedText(recognizedText);
                
                if (!cleanedText) {
                    UI.updateStatus("æ²¡æœ‰è¯†åˆ«å‡ºæœ‰æ•ˆæ±‰å­—ï¼Œè¯·é‡è¯•", "warning");
                    setTimeout(() => {
                        UI.updateStatus("è¯·é‡è¯•ï¼šç‚¹å‡»éº¦å…‹é£ï¼Œå¤§å£°è¯»å‡ºè¿™ä¸ªå­—");
                        UI.test.micBtn.disabled = false;
                        UI.test.micBtn.textContent = 'ğŸ¤';
                    }, AppData.state.feedbackDelay);
                    return;
                }

                const { currentIndex, testChars } = AppData.state;
                const currentWord = testChars[currentIndex];
                const expectedPinyins = currentWord.pinyins;
                
                let isCorrect = cleanedText.startsWith(currentWord.character) || 
                                cleanedText.includes(currentWord.character);

                if (!isCorrect) {
                    const recognizedPinyins = Utils.getPinyinsFromText(cleanedText);
                    isCorrect = recognizedPinyins.length > 0 && expectedPinyins.some(p => recognizedPinyins.includes(p));
                }
                
                AppData.state.testResults.push({
                    character: currentWord.character, 
                    expected: expectedPinyins,
                    recognized: originalResult,
                    isCorrect: isCorrect
                });
                
                if (isCorrect) {
                    UI.updateStatus("æ­£ç¡®ï¼âœ…", "success");
                } else {
                    UI.updateStatus(`ä¸å¯¹å“¦ï¼âŒ <br>æ­£ç¡®è¯»éŸ³: ${expectedPinyins.join(' / ')}`, "error");
                }

                setTimeout(() => {
                    AppData.state.currentIndex++;
                    this.displayNextChar();
                }, AppData.state.feedbackDelay);
            },
            showReport() {
                UI.showScreen('report');
                const { testResults, testChars, currentUser } = AppData.state;
                const correctCount = testResults.filter(res => res.isCorrect).length;
                const accuracy = (testChars.length > 0) ? (correctCount / testChars.length) * 100 : 0;
                const isPassed = accuracy >= AppData.state.passScore;
                
                UI.report.summary.innerHTML = `<p><strong>${currentUser.name}</strong> åŒå­¦ï¼Œæµ‹è¯•å®Œæˆï¼</p><p>æµ‹è¯•æ—¶é—´: <strong>${Utils.formatDateTime()}</strong></p><p>æ€»é¢˜æ•°: <strong>${testChars.length}</strong></p><p>ç­”å¯¹é¢˜æ•°: <strong style="color:var(--success-color);">${correctCount}</strong></p><p>æ­£ç¡®ç‡: <strong style="color:${isPassed ? 'var(--success-color)' : 'var(--danger-color)'};">${accuracy.toFixed(0)}%</strong></p><p>æµ‹è¯•ç»“æœ: <strong style="color:${isPassed ? 'var(--success-color)' : 'var(--danger-color)'};">${isPassed ? 'é€šè¿‡' : 'éœ€è¦åŠ å¼º'}</strong></p>`;
                
                const errors = testResults.filter(res => !res.isCorrect);
                UI.report.errorTableBody.innerHTML = '';
                
                if (errors.length === 0) {
                    UI.report.noErrors.classList.remove('hidden');
                    UI.report.errorTable.classList.add('hidden');
                } else {
                    UI.report.noErrors.classList.add('hidden');
                    UI.report.errorTable.classList.remove('hidden');
                    errors.forEach(err => {
                        UI.report.errorTableBody.innerHTML += `<tr><td>${err.character}</td><td>${err.expected.join(' / ')}</td><td>${err.recognized}</td></tr>`;
                    });
                }
                
                Utils.saveTestHistory({
                    student: currentUser, date: Utils.formatDateTime(),
                    totalCount: testChars.length, correctCount, accuracy: accuracy.toFixed(0),
                    isPassed, results: testResults
                });
            },
            restartApp() {
                location.reload();
            },
            downloadReport() {
                if (typeof XLSX === 'undefined') { alert("é”™è¯¯ï¼šæ— æ³•ç”Ÿæˆ Excel æ–‡ä»¶ï¼Œç›¸å…³åº“æœªèƒ½åŠ è½½ã€‚"); return; }
                const { currentUser, testResults, testChars } = AppData.state;
                const correctCount = testResults.filter(res => res.isCorrect).length;
                const accuracy = (testChars.length > 0) ? (correctCount / testChars.length) * 100 : 0;
                const isPassed = accuracy >= AppData.state.passScore;
                const errors = testResults.filter(res => !res.isCorrect);

                const summaryData = [
                    ["è¯†å­—æµ‹è¯•æŠ¥å‘Š"], [], ["å­¦ç”Ÿå§“å", currentUser.name], ["å­¦ç”Ÿå­¦å·", currentUser.id],
                    ["æµ‹è¯•æ—¶é—´", Utils.formatDateTime()], [], ["--- æµ‹è¯•æ‘˜è¦ ---"],
                    ["æ€»é¢˜æ•°", testChars.length], ["ç­”å¯¹é¢˜æ•°", correctCount],
                    ["æ­£ç¡®ç‡", `${accuracy.toFixed(0)}%`], ["æµ‹è¯•ç»“æœ", isPassed ? 'é€šè¿‡' : 'éœ€è¦åŠ å¼º']
                ];
                const errorsData = [["æ±‰å­—", "æ­£ç¡®å‘éŸ³", "ä½ çš„å‘éŸ³(è¯†åˆ«ç»“æœ)"]];
                errors.forEach(err => errorsData.push([err.character, err.expected.join(' / '), err.recognized]));
                if (errors.length === 0) errorsData.push(["å¤ªæ£’äº†ï¼Œå…¨éƒ¨æ­£ç¡®ï¼"]);

                const wb = XLSX.utils.book_new();
                const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
                wsSummary['!cols'] = [{ wch: 20 }, { wch: 40 }];
                wsSummary['!merges'] = [{ s: { r: 0, c: 0 }, e: { r: 0, c: 1 } }];
                XLSX.utils.book_append_sheet(wb, wsSummary, "æµ‹è¯•æ‘˜è¦");
                const wsErrors = XLSX.utils.aoa_to_sheet(errorsData);
                wsErrors['!cols'] = [{ wch: 10 }, { wch: 25 }, { wch: 40 }];
                XLSX.utils.book_append_sheet(wb, wsErrors, "é”™è¯¯åˆ—è¡¨");
                XLSX.writeFile(wb, `è¯†å­—æµ‹è¯•æŠ¥å‘Š-${currentUser.name}-${Utils.formatDateTime().split(' ')[0]}.xlsx`);
            },
            // --- ç®¡ç†å‘˜åŠŸèƒ½ç›¸å…³å‡½æ•° ---
            loadCustomCharLibrary() {
                try {
                    const customLib = localStorage.getItem(AppData.admin.charLibKey);
                    if (customLib) {
                        const parsedLib = JSON.parse(customLib);
                        if (Array.isArray(parsedLib) && parsedLib.length > 0) {
                            AppData.characters = parsedLib;
                            console.log(`å·²åŠ è½½ ${parsedLib.length} ä¸ªè‡ªå®šä¹‰æ±‰å­—ã€‚`);
                        }
                    }
                } catch (e) { console.error("åŠ è½½è‡ªå®šä¹‰å­—åº“å¤±è´¥:", e); }
            },
            showAdminLogin() {
                UI.showScreen('admin');
                UI.admin.panel.classList.add('hidden');
                UI.admin.loginForm.classList.remove('hidden');
                UI.admin.passwordInput.value = '';
                UI.admin.errorMsg.textContent = '';
            },
            handleAdminLogin() {
                if (UI.admin.passwordInput.value === AppData.admin.password) {
                    UI.admin.errorMsg.textContent = '';
                    UI.admin.panel.classList.remove('hidden');
                    UI.admin.loginForm.classList.add('hidden');
                    this.updateCharLibStatus();
                } else {
                    UI.admin.errorMsg.textContent = 'å¯†ç é”™è¯¯ï¼';
                }
            },
            updateCharLibStatus() {
                const count = AppData.characters.length;
                const isDefault = JSON.stringify(AppData.characters) === JSON.stringify(this.getDefaultCharacters());
                UI.admin.libStatus.innerHTML = `å½“å‰å­—åº“åŒ…å« <strong>${count}</strong> ä¸ªæ±‰å­—ã€‚<br>çŠ¶æ€: <strong>${isDefault ? 'é»˜è®¤å­—åº“' : 'è‡ªå®šä¹‰å­—åº“'}</strong>`;
                UI.admin.uploadStatus.textContent = '';
            },
            getDefaultCharacters() {
                return [
                    { character: "å¥½", pinyins: ["hao3"] }, { character: "è¡Œ", pinyins: ["xing2", "hang2"] },
                    { character: "ä¹", pinyins: ["le4", "yue4"] }, { character: "ä¸º", pinyins: ["wei2", "wei4"] },
                    { character: "ä¸­", pinyins: ["zhong1", "zhong4"] }
                ];
            },
            handleFileUpload(event) {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => this.parseAndSaveCharLibrary(e.target.result);
                reader.readAsText(file, 'UTF-8');
            },
            parseAndSaveCharLibrary(csvText) {
                try {
                    const lines = csvText.trim().split(/\r?\n/);
                    if (lines.length < 2 || lines[0].trim().toLowerCase() !== 'character,pinyins') {
                        throw new Error("CSVæ ¼å¼é”™è¯¯ï¼Œç¬¬ä¸€è¡Œè¡¨å¤´å¿…é¡»æ˜¯ 'character,pinyins'");
                    }
                    const newLib = [];
                    for (let i = 1; i < lines.length; i++) {
                        const parts = lines[i].split(',');
                        if (parts.length >= 2) {
                            const character = parts[0].trim();
                            const pinyinsStr = parts[1].trim();
                            if (character && pinyinsStr) {
                                newLib.push({ character: character, pinyins: pinyinsStr.split('/') });
                            }
                        }
                    }
                    if (newLib.length === 0) throw new Error("æœªèƒ½ä»æ–‡ä»¶ä¸­è§£æå‡ºä»»ä½•æ±‰å­—æ•°æ®ã€‚");

                    localStorage.setItem(AppData.admin.charLibKey, JSON.stringify(newLib));
                    AppData.characters = newLib;
                    UI.admin.uploadStatus.style.color = 'var(--success-color)';
                    UI.admin.uploadStatus.textContent = `æˆåŠŸä¸Šä¼ å¹¶åº”ç”¨äº† ${newLib.length} ä¸ªæ±‰å­—ï¼`;
                    this.updateCharLibStatus();
                } catch (e) {
                    UI.admin.uploadStatus.style.color = 'var(--danger-color)';
                    UI.admin.uploadStatus.textContent = `ä¸Šä¼ å¤±è´¥: ${e.message}`;
                } finally {
                    UI.admin.fileInput.value = '';
                }
            },
            resetCharLibrary() {
                if (confirm("ç¡®å®šè¦æ¸…ç©ºè‡ªå®šä¹‰å­—åº“å¹¶æ¢å¤ä¸ºç³»ç»Ÿé»˜è®¤å­—åº“å—ï¼Ÿ")) {
                    localStorage.removeItem(AppData.admin.charLibKey);
                    AppData.characters = this.getDefaultCharacters();
                    UI.admin.uploadStatus.textContent = "å·²æ¢å¤ä¸ºé»˜è®¤å­—åº“ã€‚";
                    this.updateCharLibStatus();
                }
            },
            warmUpSpeechRecognition() {
                try {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    const recognition = new SpeechRecognition();
                    recognition.lang = 'zh-CN';
                    recognition.start();
                    setTimeout(() => {
                        recognition.stop();
                    }, 100);
                } catch (e) {
                    console.warn("Speech recognition warm-up failed:", e);
                }
            }
        };
        
        document.addEventListener('DOMContentLoaded', () => App.init());
    </script>
</body>
</html>
